import os
import pickle
import numpy as np

# Define your base output directory
base_dir = "/users/mnima/alphafold_EGF/outputs_batch1"

# Loop through each prediction output folder
for output_folder in os.listdir(base_dir):
    output_path = os.path.join(base_dir, output_folder)
    if not os.path.isdir(output_path):
        continue

    # Subdirectory where results are stored
    subfolders = os.listdir(output_path)
    if not subfolders:
        continue

    subdir = os.path.join(output_path, subfolders[0])
    print(f"\n=== Results for {output_folder} ===")

    model_data = []

    for filename in os.listdir(subdir):
        if filename.startswith("result_model") and filename.endswith(".pkl"):
            full_path = os.path.join(subdir, filename)

            with open(full_path, "rb") as f:
                result = pickle.load(f)

            iptm = result.get('iptm', 0.0)
            ptm = result.get('ptm', 0.0)
            plddt = np.array(result.get('plddt', []))
            mean_plddt = float(np.mean(plddt)) if plddt.size > 0 else 0.0
            confidence = iptm * ptm

            model_data.append((filename, iptm, ptm, mean_plddt, confidence))

    # Sort by ipTM descending
    model_data.sort(key=lambda x: x[1], reverse=True)

    for fname, iptm, ptm, plddt, conf in model_data:
        print(f"{fname}: ipTM={iptm:.4f}, pTM={ptm:.4f}, mean pLDDT={plddt:.2f}, confidence={conf:.4f}")

    high_conf_models = [m for m in model_data if m[4] > 0.5]
    if high_conf_models:
        print(f"→ {len(high_conf_models)} model(s) with confidence > 0.5")
    else:
        print("→ No models with confidence > 0.5")

    high_iptm_models = [m for m in model_data if m[1] > 0.75]
    if high_iptm_models:
        print(f"→ {len(high_iptm_models)} model(s) with ipTM > 0.75")
    else:
        print("→ No models with ipTM > 0.75")
